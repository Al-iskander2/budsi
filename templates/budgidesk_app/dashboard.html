{% extends 'budgidesk_app/base.html' %}
{% load humanize %}
{% load static %}

{% block content %}
<style>
/* MÉTODO NUCLEAR — normalizado sin 100vw */
html, body.dashboard-page{
  margin:0 !important;
  padding:0 !important;
  width:100% !important;         /* antes 100vw → causa overflow */
  overflow-x:hidden !important;  /* cinturón de seguridad */
}

/* Contenedor principal pegado a bordes, sin overflow */
.dashboard-container{
  margin:0 !important;
  padding:0 !important;
  width:100% !important;         /* antes 100vw */
  max-width:100% !important;     /* evita desbordes con scrollbar */
  display:flex;
  min-height:calc(100vh - 80px);
  overflow-x:hidden;
}

/* Sidebar y contenido principal */
.sidebar{
  margin:0 !important;
  padding:20px !important;
  width:200px !important;
  background:#fff;
  box-shadow:2px 0 10px rgba(0,0,0,.1);
  flex-shrink:0;
}
.main-content{
  margin:0 !important;
  padding:30px !important;
  flex:1 1 auto;
  max-width:none !important;
  overflow-x:hidden;
}

/* Logos controlados (navbar/header) */
.navbar-brand img,
header img,
img[alt*="logo" i]{
  max-height:10px !important;
  height:auto !important;
  width:auto !important;
}

/* Anular gutters de Bootstrap SOLO en el dashboard */
body.dashboard-page .container,
body.dashboard-page .container-fluid{
  padding-left:0 !important;
  padding-right:0 !important;
  margin-left:0 !important;
  margin-right:0 !important;
}
body.dashboard-page .row{
  --bs-gutter-x:0;               /* Bootstrap 5: gutters = 0 */
}

/* Wrapper global del base.html */
main.main-wrapper{
  padding-top:1px !important;
  margin-top:0 !important;
  margin:0 !important;
  padding-left:0 !important;
  padding-right:0 !important;
  width:100% !important;
  max-width:100% !important;
}

/* Tu paleta y tarjetas tal cual */
:root{
  --primary-1:#4B49AC;--primary-2:#98BDFF;--supporting-1:#7DA0FA;--supporting-2:#7978E9;--supporting-3:#F3797E;
  --white:#ffffff;--gray-light:#f5f5f5;--gray-border:#e0e0e0;--amber:#f39c12;
}
*{box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
.logo{display:flex;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid var(--gray-border);}
.menu-item{display:flex;align-items:center;padding:12px 15px;border-radius:8px;margin-bottom:8px;cursor:pointer;transition:.3s;text-decoration:none;color:var(--primary-1);}
.menu-item:hover{background-color:rgba(75,73,172,.1);}
.menu-item.active{background-color:var(--primary-1);color:#fff;}
.cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:25px;width:100%;}
.card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 5px 15px rgba(0,0,0,.08);transition:transform .3s,box-shadow .3s;border-top:4px solid var(--supporting-1);max-width:100%;}
.card:hover{transform:translateY(-5px);box-shadow:0 8px 20px rgba(0,0,0,.12);}
.card-header{padding:20px;border-bottom:1px solid #f1f1f1;}
.card-title{font-size:18px;font-weight:600;color:var(--primary-1);}
.card-body{padding:20px;}
.card canvas{width:100% !important;height:240px !important;display:block;}
.summary-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-top:1rem;}
.summary-item{text-align:center;padding:1rem;background:var(--gray-light);border-radius:10px;transition:.2s;}
.summary-item:hover{background:var(--primary-2);color:#fff;}
.summary-value{font-size:1.5rem;font-weight:800;color:var(--primary-1);}
.summary-item:hover .summary-value{color:#fff;}
.summary-label{font-size:.9rem;color:#64748b;}
.reminders-list{list-style:none;padding:0;margin:0;}
.reminder-item{display:flex;justify-content:space-between;align-items:center;padding:.75rem 0;border-bottom:1px solid var(--gray-border);}
.reminder-item:last-child{border-bottom:0;}
.reminder-actions{display:flex;gap:.5rem;}
.reminder-actions button{background:none;border:none;cursor:pointer;color:var(--primary-1);}
.priority-high .reminder-message{font-weight:700;color:var(--supporting-3);}
.priority-medium .reminder-message{color:var(--amber);}
.priority-low .reminder-message{color:var(--primary-1);}
.spending-container{position:relative;height:240px;}
.spending-legend{display:grid;grid-template-columns:repeat(2,1fr);gap:.5rem;margin-top:1rem;max-height:150px;overflow-y:auto;padding-right:5px;}
.spending-legend-item{display:flex;align-items:center;font-size:.75rem;margin-bottom:.4rem;}
.spending-color{width:12px;height:12px;border-radius:3px;margin-right:.5rem;flex-shrink:0;}
.spending-label{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:120px;color:var(--primary-1);}
.spending-percentage{margin-left:auto;font-weight:600;color:var(--primary-1);}
.comparison-card{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-top:1.5rem;}
.comparison-item{text-align:center;padding:1rem;background:var(--gray-light);border-radius:12px;}
.comparison-year{font-size:.875rem;color:#64748b;margin-bottom:.5rem;}
.comparison-value{font-size:1.5rem;font-weight:700;color:var(--primary-1);}
.apps-panel{position:fixed;top:50%;right:0;transform:translateY(-50%);z-index:1000;}
.apps-trigger{width:40px;height:40px;background:linear-gradient(90deg,var(--primary-1),var(--supporting-2));color:#fff;border-radius:8px 0 0 8px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:-2px 0 8px rgba(0,0,0,.15);transition:.3s;}
.apps-trigger:hover{width:45px;}
.apps-content{position:absolute;top:0;right:-300px;width:200px;background:#fff;padding:1.5rem;border-radius:6px 0 0 6px;box-shadow:-15px 0 15px rgba(0,0,0,.1);transition:right .3s;border-left:3px solid var(--supporting-3);max-height:80vh;overflow-y:auto;}
.apps-panel:hover .apps-content{right:80px;}
.link-list{display:flex;flex-direction:column;gap:.8rem;}
.app-link{padding:.8rem;text-decoration:none;color:var(--primary-1);font-weight:500;transition:.2s;border-radius:6px;text-align:center;}
.app-link:hover{background-color:var(--gray-light);color:var(--supporting-2);}

/* Responsive */
@media (max-width: 992px){
  .sidebar{width:80px;padding:15px 10px;}
}
@media (max-width: 768px){
  .dashboard-container{flex-direction:column;}
  .sidebar{width:100%;height:auto;padding:10px;}
  .main-content{padding:15px;}
}
</style>


<div class="dashboard-container">
  <aside class="sidebar">
    <div class="logo">
    <h1 style="color: #4B49AC; font-size: 1.2rem;">Dashboard</h1>
    </div>
    <!-- Mantén tus rutas actuales para no romper navegación -->
    <a href="{% url 'invoice_list' %}" class="menu-item"><span>Invoices<br>Credit Notes</span></a>
    <a href="{% url 'expense_list' %}" class="menu-item"><span>Expenses</span></a>
    <a href="{% url 'tax_report' %}" class="menu-item"><span>Tax</span></a>
    <a href="{% url 'dash_pulse' %}" class="menu-item"><span>Pulse</span></a>
    <a href="{% url 'legal_templates' %}" class="menu-item"><span>Docs</span></a>
    <a href="{% url 'dash_track' %}" class="menu-item"><span>Track</span></a>
  </aside>

  <main class="main-content">
    <div class="cards-grid">
      <!-- Monthly Income Overview -->
      <div class="card">
        <div class="card-header"><h3 class="card-title">Monthly Income Overview</h3></div>
        <div class="card-body">
          {% if monthly_income %}
            <canvas id="incomeChart"></canvas>
          {% else %}
            <div class="no-data">
              <p>No income data available</p>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Revenue vs Expenses -->
      <div class="card">
        <div class="card-header"><h3 class="card-title">Revenue vs Expenses</h3></div>
        <div class="card-body">
          {% if revenue_expenses.revenue > 0 or revenue_expenses.expenses > 0 %}
            <canvas id="expensesChart"></canvas>
          {% else %}
            <div class="no-data"><p>No revenue/expense data available</p></div>
          {% endif %}
        </div>
      </div>

      <!-- Buzz (Reminders) -->
      <div class="card">
        <div class="card-header"><h3 class="card-title">Buzz</h3></div>
        <div class="card-body">
          <ul class="reminders-list" id="reminders-list">
            {% for reminder in smart_reminders %}
              <li class="reminder-item priority-{{ reminder.priority }}">
                <div class="reminder-content">
                  <p class="reminder-message">{{ reminder.message }}</p>
                  <div class="reminder-date">Due: {{ reminder.due_date }}</div>
                </div>
                <div class="reminder-actions">
                  <button title="Mark as done" onclick="toggleReminder('{{ reminder.id }}')">
                    <i class="fas fa-check"></i>
                  </button>
                </div>
              </li>
            {% empty %}
              <li class="reminder-item"><div class="reminder-content"><p class="reminder-message">No pending reminders</p></div></li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <!-- Tax Summary -->
      <div class="card">
        <div class="card-header"><h3 class="card-title">Tax Summary</h3></div>
        <div class="card-body">
          <div class="summary-grid">
            <div class="summary-item"><div class="summary-value">€{{ tax_data.vat.liability|default:0|floatformat:2 }}</div><div class="summary-label">VAT Liability</div></div>
            <div class="summary-item"><div class="summary-value">€{{ tax_data.income_tax.net|default:0|floatformat:2 }}</div><div class="summary-label">Income Tax</div></div>
            <div class="summary-item"><div class="summary-value">€{{ tax_data.usc.total|default:0|floatformat:2 }}</div><div class="summary-label">USC</div></div>
            <div class="summary-item"><div class="summary-value">€{{ tax_data.prsi|default:0|floatformat:2 }}</div><div class="summary-label">PRSI</div></div>
          </div>
        </div>
      </div>

      <!-- Spending Wheel -->
      <div class="card">
        <div class="card-header"><h3 class="card-title">Spending Wheel</h3></div>
        <div class="card-body">
          {% if spending_data and spending_data|length > 0 %}
            <div class="spending-container"><canvas id="spendingWheelChart"></canvas></div>
            <div class="spending-legend" id="spendingLegend"></div>
          {% else %}
            <div class="no-data"><p>No spending data available</p></div>
          {% endif %}
        </div>
      </div>

      <!-- Performance Uptrend -->
      <div class="card">
        <div class="card-header"><h3 class="card-title">Performance Uptrend</h3></div>
        <div class="card-body">
          <div class="comparison-card">
            <div class="comparison-item">
              <div class="comparison-year">{{ current_year }}</div>
              <div class="comparison-value">€{{ annual_comparison.current_year|default:0|floatformat:2 }}</div>
            </div>
            <div class="comparison-item">
              <div class="comparison-year">{{ previous_year }}</div>
              <div class="comparison-value">€{{ annual_comparison.previous_year|default:0|floatformat:2 }}</div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>
</div>

<!-- Floating apps widget (solo 2 enlaces, como el limpio) -->
<div class="apps-panel">
  <div class="apps-trigger"><i class="fas fa-th"></i></div>
  <div class="apps-content">
    <h4>Apps</h4>
    <div class="link-list">
      <a href="{% url 'dash_whiz' %}" class="app-link">Budsi Whiz</a>
      <a href="{% url 'dash_help' %}" class="app-link">Help Support</a>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ===== Django -> JS =====
  const monthlyIncomeData = {
    labels: [{% for item in monthly_income %}'{{ item.month }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
    data: [{% for item in monthly_income %}{{ item.total|default:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}]
  };
  const revenueExpensesData = { revenue: {{ revenue_expenses.revenue|default:0 }}, expenses: {{ revenue_expenses.expenses|default:0 }} };
  const spendingData = {{ spending_data|safe|default:"[]" }};

  document.addEventListener('DOMContentLoaded', () => {
    initCharts();
    {% if spending_data and spending_data|length > 0 %} initSpendingWheel(); {% endif %}
  });

  function initCharts(){
    // === Monthly Income (línea) ===
    {% if monthly_income %}
      const incomeCtx = document.getElementById('incomeChart').getContext('2d');
      new Chart(incomeCtx,{
        type:'line',
        data:{
          labels:monthlyIncomeData.labels,
          datasets:[{
            label:'Income (€)',
            data:monthlyIncomeData.data,
            borderColor:getComputedStyle(document.documentElement).getPropertyValue('--primary-1').trim(),
            backgroundColor:'rgba(75,73,172,.1)',
            tension:.3,fill:true
          }]
        },
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}
      });
    {% endif %}

    // === Revenue vs Expenses (barras) ===
    {% if revenue_expenses.revenue > 0 or revenue_expenses.expenses > 0 %}
      const rootStyles = getComputedStyle(document.documentElement);
      const colorRevenue  = rootStyles.getPropertyValue('--primary-1').trim();     // del tema
      const colorExpenses = rootStyles.getPropertyValue('--supporting-3').trim();  // del tema

      const expensesCtx = document.getElementById('expensesChart').getContext('2d');
      new Chart(expensesCtx,{
        type:'bar',
        data:{
          labels:['Revenue','Expenses'],
          datasets:[{
            label:'Amount (€)',
            data:[revenueExpensesData.revenue,revenueExpensesData.expenses],
            backgroundColor:[colorRevenue,colorExpenses],
            borderWidth:0
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{legend:{display:false}},
          scales:{
            x:{grid:{display:false}},
            y:{beginAtZero:true,grid:{color:'rgba(0,0,0,0.05)'}}
          }
        }
      });
    {% endif %}
  }

  function initSpendingWheel(){
    const ctx = document.getElementById('spendingWheelChart').getContext('2d');
    new Chart(ctx,{
      type:'doughnut',
      data:{
        labels:spendingData.map(i=>i.category),
        datasets:[{
          data:spendingData.map(i=>i.percentage),
          backgroundColor:spendingData.map(i=>i.color),
          borderWidth:1,borderColor:'#fff'
        }]
      },
      options:{
        responsive:true,maintainAspectRatio:false,cutout:'65%',
        plugins:{legend:{display:false},tooltip:{callbacks:{label:(c)=>`${c.label}: ${c.raw}%`}}}
      }
    });
    const legend = document.getElementById('spendingLegend'); legend.innerHTML='';
    spendingData.forEach(i=>{
      const d=document.createElement('div');
      d.className='spending-legend-item';
      d.innerHTML=`<div class="spending-color" style="background-color:${i.color};"></div>
                   <div class="spending-label">${i.category}</div>
                   <div class="spending-percentage">${i.percentage}%</div>`;
      legend.appendChild(d);
    });
  }

  function toggleReminder(id){
    const item = event.target.closest('.reminder-item');
    item.style.opacity='0.6'; item.style.textDecoration='line-through';
    setTimeout(()=>item.remove(),1000);
  }
</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}
