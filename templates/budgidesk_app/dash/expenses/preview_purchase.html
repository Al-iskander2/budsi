{% extends 'budgidesk_app/base.html' %}
{% block title %}Expense Preview{% endblock %}
{% load static %}
{% block content %}

<div class="preview-wrap">
  <div class="grid">
    <!-- Left: Original document -->
    <div class="panel">
      <h2>Original Document</h2>
      <div class="panel-body">
        {% if original_url %}
          <div class="docbox">
            {% if is_pdf %}
              <embed src="{{ original_url }}" type="application/pdf" />
            {% else %}
              <img src="{{ original_url }}" alt="original invoice"/>
            {% endif %}
          </div>
          <p class="note">File: {{ invoice.original_file.name }}</p>
        {% else %}
          <div class="docbox"><em>No original file attached.</em></div>
        {% endif %}
      </div>
    </div>

    <!-- Right: Editable form -->
    <div class="panel">
      <h2>Extracted Data (Edit as needed)</h2>
      <div class="panel-body">
        
        <!-- DEBUG INFO -->
        <div style="background: #e8f5e8; padding: 10px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #01BF1F;">
          <strong>OCR procesado correctamente:</strong><br>
          Total: €{{ invoice.total|floatformat:2 }} | 
          VAT: €{{ invoice.vat_amount|floatformat:2 }} | 
          Subtotal: €{{ invoice.subtotal|floatformat:2 }}
        </div>

        <form method="post">
          {% csrf_token %}
          <div class="row">
            <div>
              <label>Client / Supplier</label>
              {{ form.contact }}
            </div>
            <div>
              <label>Date</label>
              {{ form.date }}
            </div>
            <div>
              <label>Total</label>
              <input type="number" name="subtotal" value="{{ invoice.subtotal|floatformat:2 }}" step="0.01" required 
                     style="width:100%;padding:10px 12px;border:1px solid rgba(50,78,162,.35);border-radius:10px">
            </div>
            <div>
              <label>VAT</label>
              <input type="number" name="vat_amount" value="{{ invoice.vat_amount|floatformat:2 }}" step="0.01" required
                     style="width:100%;padding:10px 12px;border:1px solid rgba(50,78,162,.35);border-radius:10px">
            </div>
            <div style="grid-column:1/-1">
              <label>Expense Category</label>
              <select name="category" required style="width:100%;padding:10px 12px;border:1px solid rgba(50,78,162,.35);border-radius:10px">
                <option value="">Select a category</option>
                <option value="Office and Workspace" {% if invoice.category == "Office and Workspace" %}selected{% endif %}>Office and Workspace</option>
                <option value="Equipment and Supplies" {% if invoice.category == "Equipment and Supplies" %}selected{% endif %}>Equipment and Supplies</option>
                <option value="Software and Subscriptions" {% if invoice.category == "Software and Subscriptions" %}selected{% endif %}>Software and Subscriptions</option>
                <option value="Travel and Accommodation" {% if invoice.category == "Travel and Accommodation" %}selected{% endif %}>Travel and Accommodation</option>
                <option value="Marketing and Advertising" {% if invoice.category == "Marketing and Advertising" %}selected{% endif %}>Marketing and Advertising</option>
                <option value="Professional Services" {% if invoice.category == "Professional Services" %}selected{% endif %}>Professional Services</option>
                <option value="Utilities" {% if invoice.category == "Utilities" %}selected{% endif %}>Utilities</option>
                <option value="Other" {% if invoice.category == "Other" %}selected{% endif %}>Other</option>
              </select>
            </div>
            <div style="grid-column:1/-1">
              <label>Assign to Project (Optional)</label>
              <select name="project" style="width:100%;padding:10px 12px;border:1px solid rgba(50,78,162,.35);border-radius:10px">
                  <option value="">No Project</option>
                  {% for project in existing_projects %}
                  <option value="{{ project }}" {% if invoice.project == project %}selected{% endif %}>
                      {{ project }}
                  </option>
                  {% endfor %}
              </select>
              <p class="note">Assign this expense to a project for better tracking</p>
            </div>
            <div style="grid-column:1/-1">
              <label>Description</label>
              {{ form.description }}
            </div>
          </div>

          <div id="vat-warning" class="warn" style="display: none; background: #fff3cd; color: #856404; padding: 10px; border-radius: 4px; margin: 10px 0; border-left: 4px solid #ffeaa7;">
            VAT amount seems inconsistent with subtotal.
          </div>

          <div class="actions" style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
            <a href="{% url 'expense_list' %}" class="btn btn-secondary" style="padding: 10px 20px; background: #6c757d; color: white; text-decoration: none; border-radius: 4px;">Cancel</a>
            <button type="submit" name="confirm" class="btn btn-primary" style="padding: 10px 20px; background: #4B49AC; color: white; border: none; border-radius: 4px; cursor: pointer;">Confirm & Save</button>
          </div>
          <p class="note" style="margin-top: 15px; font-size: 0.8rem; color: #6c757d;">OCR data stored: {{ invoice.ocr_data|default:"{}" }}</p>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
.preview-wrap {
  width: 100%;
  padding: 2rem;
  box-sizing: border-box;
}

.grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem;
  margin-top: 1rem;
}

.panel {
  background: white;
  border-radius: 0.5rem;
  box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
  overflow: hidden;
}

.panel h2 {
  padding: 1rem;
  margin: 0;
  border-bottom: 1px solid #e9ecef;
  font-size: 1.25rem;
  color: #4B49AC;
}

.panel-body {
  padding: 1.5rem;
}

.docbox {
  border: 1px solid #e9ecef;
  border-radius: 8px;
  padding: 1rem;
  text-align: center;
  min-height: 400px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.docbox embed, 
.docbox img {
  max-width: 100%;
  max-height: 400px;
  border-radius: 4px;
}

.note {
  font-size: 0.875rem;
  color: #6c757d;
  margin-top: 0.5rem;
}

.row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

.row div {
  display: flex;
  flex-direction: column;
}

label {
  font-weight: 600;
  margin-bottom: 0.5rem;
  color: #495057;
}

input, select, textarea {
  padding: 10px 12px;
  border: 1px solid rgba(50, 78, 162, 0.35);
  border-radius: 10px;
  font-size: 0.9rem;
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: #4B49AC;
  box-shadow: 0 0 0 2px rgba(75, 73, 172, 0.1);
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  text-decoration: none;
  display: inline-block;
  font-weight: 500;
  transition: all 0.3s ease;
}

.btn-primary {
  background: #4B49AC;
  color: white;
}

.btn-primary:hover {
  background: #3a3899;
  transform: translateY(-1px);
}

.btn-secondary {
  background: #6c757d;
  color: white;
}

.btn-secondary:hover {
  background: #5a6268;
  transform: translateY(-1px);
}

@media (max-width: 768px) {
  .grid {
    grid-template-columns: 1fr;
  }
  
  .row {
    grid-template-columns: 1fr;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Validación de VAT
    const subtotalInput = document.querySelector('input[name="subtotal"]');
    const vatInput = document.querySelector('input[name="vat_amount"]');
    const vatWarning = document.getElementById('vat-warning');
    
    function validateVAT() {
        const subtotal = parseFloat(subtotalInput.value) || 0;
        const vat = parseFloat(vatInput.value) || 0;
        
        // Mostrar advertencia si VAT es más del 30% del subtotal (ajustable)
        if (vat > 0 && subtotal > 0 && vat > subtotal * 0.3) {
            vatWarning.style.display = 'block';
        } else {
            vatWarning.style.display = 'none';
        }
    }
    
    if (subtotalInput && vatInput) {
        subtotalInput.addEventListener('input', validateVAT);
        vatInput.addEventListener('input', validateVAT);
        validateVAT(); // Validar al cargar
    }
    
    // Mensaje de confirmación antes de salir si hay cambios sin guardar
    let formChanged = false;
    const form = document.querySelector('form');
    const formInputs = form.querySelectorAll('input, select, textarea');
    
    formInputs.forEach(input => {
        input.addEventListener('change', function() {
            formChanged = true;
        });
    });
    
    window.addEventListener('beforeunload', function(e) {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
    
    // Prevenir el mensaje cuando se envía el formulario
    form.addEventListener('submit', function() {
        formChanged = false;
    });
});
</script>

{% endblock %}