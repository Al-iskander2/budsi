{% extends 'budgidesk_app/base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<style>
  :root{
    --primary-1:#4B49AC; --primary-2:#98BDFF;
    --supporting-1:#7DA0FA; --supporting-2:#7978E9; --supporting-3:#F3797E;
    --white:#fff; --gray-light:#f5f5f5; --gray-border:#e0e0e0;
    --amber:#f39c12; --green:#10b981; --red:#ef4444; --purple:#8b5cf6;
  }
  .dashboard-container{display:grid;grid-template-columns:1fr 350px;gap:2rem;max-width:1400px;margin:0 auto;padding:20px;}
  .main-content{display:flex;flex-direction:column;gap:2rem;}
  .tracker-header{background:#fff;border-bottom:1px solid var(--gray-border);padding:1.5rem 0;margin-bottom:1rem;}
  .header-content{max-width:1400px;margin:0 auto;padding:0 1rem;display:flex;justify-content:space-between;align-items:center;}
  .header-title h1{margin:0;color:var(--primary-1);font-size:1.75rem;font-weight:700}
  .header-title p{margin:0;color:var(--primary-2)}
  .btn{display:inline-flex;align-items:center;padding:.5rem 1rem;border-radius:.5rem;font-weight:500;border:none;cursor:pointer}
  .btn-primary{background:var(--primary-1);color:#fff}
  .btn-primary:hover{background:var(--supporting-2)}
  /* Stats */
  .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1.5rem}
  .stat-card{background:#fff;border:1px solid var(--gray-border);border-radius:.75rem;box-shadow:0 1px 3px rgba(0,0,0,.08);padding:1.5rem;text-align:center}
  .stat-icon{width:56px;height:56px;border-radius:50%;display:grid;place-items:center;margin:0 auto .75rem}
  .stat-icon.blue{background:#dbeafe;color:var(--primary-1)}
  .stat-icon.green{background:#d1fae5;color:var(--green)}
  .stat-icon.red{background:#fee2e2;color:var(--red)}
  .stat-icon.purple{background:#ede9fe;color:var(--purple)}
  .stat-info p{margin:0;color:var(--primary-2);font-size:.875rem}
  .stat-info h3{margin:0;color:var(--primary-1);font-size:1.5rem;font-weight:700}
  /* Cards */
  .projects-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1.5rem}
  .project-card{background:#fff;border:1px solid var(--gray-border);border-radius:.75rem;box-shadow:0 1px 3px rgba(0,0,0,.08);padding:1.25rem}
  .project-card:hover{box-shadow:0 4px 6px rgba(0,0,0,.1)}
  .project-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.75rem}
  .project-info{display:flex;gap:.75rem;align-items:center}
  .project-color{width:.75rem;height:.75rem;border-radius:50%}
  .project-name{margin:0;color:var(--primary-1);font-weight:700}
  .project-stage{margin:0;color:var(--primary-2);font-size:.9rem}
  .progress-section{margin:.75rem 0}
  .progress-info{display:flex;justify-content:space-between;font-size:.875rem;margin-bottom:.4rem}
  .progress-bar{height:.5rem;background:var(--gray-light);border-radius:.25rem;overflow:hidden}
  .progress-fill{height:100%;background:var(--supporting-2)}
  .project-dates{display:flex;align-items:center;color:var(--primary-2);font-size:.9rem;margin:.75rem 0}
  .dates-icon{margin-right:.5rem}
  .financial-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem;background:var(--gray-light);border-radius:.5rem;padding:.75rem}
  .financial-item{text-align:center}
  .financial-label{color:var(--primary-2);font-size:.75rem;margin:0 0 .15rem}
  .financial-value{font-weight:700}
  .value-earned{color:var(--green)} .value-spent{color:var(--red)}
  /* Top / Best projects */
  .top-project{background:#fff;border:1px solid var(--gray-border);border-left:4px solid var(--amber);border-radius:.75rem;box-shadow:0 1px 3px rgba(0,0,0,.08);padding:1.25rem}
  .top-project-header{display:flex;align-items:center;gap:.75rem;margin-bottom:.5rem}
  .top-project-icon{background:#fef3c7;color:var(--amber);border-radius:.5rem;padding:.5rem}
  .top-project-title{margin:0;color:var(--primary-1);font-size:1.1rem;font-weight:700}
  /* Calendar */
  .calendar-sidebar{background:#fff;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.05);padding:1.25rem;border-top:4px solid var(--supporting-2);height:fit-content;position:sticky;top:20px}
  .calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem}
  .calendar-nav{display:flex;gap:.4rem}
  .calendar-nav button{background:var(--primary-1);color:#fff;border:none;border-radius:8px;width:32px;height:32px;display:grid;place-items:center;cursor:pointer}
  .calendar-nav button:hover{background:var(--supporting-2)}
  .weekdays{display:grid;grid-template-columns:repeat(7,1fr);text-align:center;color:var(--primary-1);font-weight:700;font-size:.8rem;margin-bottom:.3rem}
  .days-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:.25rem}
  .day-cell{height:34px;display:flex;align-items:center;justify-content:center;border-radius:50%;font-size:.9rem}
  .day-cell.today{background:var(--primary-1);color:#fff;font-weight:700}
  .day-cell.other-month{color:#c7c7c7}
  .calendar-events{margin-top:1rem;border-top:1px solid var(--gray-border);padding-top:1rem}
  .calendar-event{background:var(--gray-light);border-radius:.375rem;padding:.5rem;margin-bottom:.4rem}
  @media (max-width:1024px){.dashboard-container{grid-template-columns:1fr}}
</style>

<div class="project-tracker">
  <!-- Header -->
  <div class="tracker-header">
    <div class="header-content">
      <div class="header-title">
        <h1>Project Tracker</h1>
        <p>Monitor and manage your projects financial performance</p>
      </div>
      <div class="header-buttons">
        <button class="btn btn-primary" id="new-project-btn">
          <i class="fas fa-plus" style="margin-right:.5rem;"></i> New Project
        </button>
      </div>
    </div>
  </div>

  <!-- Main -->
  <div class="dashboard-container">
    <div class="main-content">
      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon blue"><i class="fas fa-folder-open"></i></div><div class="stat-info"><p>Active Projects</p><h3>{{ active_projects_count }}</h3></div></div>
        <div class="stat-card"><div class="stat-icon green"><i class="fas fa-euro-sign"></i></div><div class="stat-info"><p>Total Revenue</p><h3>€{{ total_earned|floatformat:2|intcomma }}</h3></div></div>
        <div class="stat-card"><div class="stat-icon red"><i class="fas fa-receipt"></i></div><div class="stat-info"><p>Total Spent</p><h3>€{{ total_spent|floatformat:2|intcomma }}</h3></div></div>
        <div class="stat-card"><div class="stat-icon purple"><i class="fas fa-piggy-bank"></i></div><div class="stat-info"><p>All Projects Total</p><h3>€{{ net_profit|floatformat:2|intcomma }}</h3></div></div>
      </div>

      <!-- Cards -->
      <div class="projects-grid" id="projects-container">
        {% for data in projects_data %}
          {% with p=data.project %}
          <div class="project-card">
            <div class="project-header">
              <div class="project-info">
                <div class="project-color" style="background: var(--supporting-1)"></div>
                <div>
                  <h3 class="project-name">{{ p.name }}</h3>
                  <p class="project-stage">
                    {% if p.is_active %}<span style="color:var(--green)">● Active</span>{% else %}<span style="color:var(--primary-1)">● Completed</span>{% endif %}
                    • {{ data.sales_count }} sales • {{ data.purchases_count }} expenses
                  </p>
                </div>
              </div>
              <div class="dropdown">
                <button class="action-btn"><i class="fas fa-ellipsis-h"></i></button>
                <div class="dropdown-content">
                  <button onclick="alert('Project details coming soon')">View Details</button>
                  <button class="delete" onclick="archiveProject({{ p.id }})">{% if p.is_active %}Archive{% else %}Activate{% endif %}</button>
                </div>
              </div>
            </div>

            <div class="progress-section">
              <div class="progress-info"><span>Progress</span><span>{{ data.progress }}%</span></div>
              <div class="progress-bar"><div class="progress-fill" style="width: {{ data.progress }}%;"></div></div>
            </div>

            <div class="project-dates">
              <i class="fas fa-calendar-alt dates-icon"></i>
              <span>{{ p.start_date|date:"M d, Y" }} - {{ p.end_date|date:"M d, Y" }}</span>
            </div>

            <div class="financial-summary">
              <div class="financial-item"><p class="financial-label">Paid to Reveniu</p><p class="financial-value value-spent">€{{ data.spent|floatformat:2|intcomma }}</p></div>
              <div class="financial-item"><p class="financial-label">Project Earnings</p><p class="financial-value value-earned">€{{ data.earned|floatformat:2|intcomma }}</p></div>
              <div class="financial-item">
                <p class="financial-label">Your Profit</p>
                <p class="financial-value" style="color:{% if data.profit >= 0 %}var(--green){% else %}var(--red){% endif %};">
                  €{{ data.profit|floatformat:2|intcomma }}
                </p>
              </div>
            </div>
          </div>
          {% endwith %}
        {% endfor %}
      </div>

      <!-- Top Project EXACT TEXT -->
      {% if profitable_project %}
      <div class="top-project">
        <div class="top-project-header">
          <div class="top-project-icon"><i class="fas fa-trophy"></i></div>
          <h3 class="top-project-title">Most Profitable Project is:</h3>
        </div>
        <div class="top-project-details">
          <h4 style="margin:0;color:var(--primary-1)">{{ profitable_project.project.name }}</h4>
        </div>
      </div>
      {% endif %}

      <!-- Best Projects (Top 5) -->
      {% if projects_data %}
        {% with sorted=projects_data|dictsortreversed:"profit" %}
        <div class="top-project">
          <div class="top-project-header">
            <div class="top-project-icon"><i class="fas fa-ranking-star"></i></div>
            <h3 class="top-project-title">Best Projects (Top {{ sorted|slice:":5"|length }})</h3>
          </div>
          <ol style="margin:0;padding-left:1.25rem">
            {% for item in sorted|slice:":5" %}
              <li style="margin:.25rem 0">
                <strong>{{ item.project.name }}</strong> — Profit: €{{ item.profit|floatformat:2|intcomma }}
                {% if item.earned %}( {% widthratio item.profit item.earned 100 %}% margin ){% endif %}
              </li>
            {% endfor %}
          </ol>
        </div>
        {% endwith %}
      {% endif %}
    </div>

    <!-- Calendar -->
    <div class="calendar-sidebar">
      <div class="calendar-header">
        <h3 id="current-month">{{ current_month }}</h3>
        <div class="calendar-nav">
          <button id="prev-month" aria-label="Previous month"><i class="fas fa-chevron-left"></i></button>
          <button id="next-month" aria-label="Next month"><i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
      <div class="weekdays"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
      <div class="days-grid" id="calendar-days"></div>
      <div class="calendar-events" id="calendar-events">
        <h4 style="color:var(--primary-1);margin-bottom:.75rem">Project Timeline</h4>
        {% for data in projects_data %}
          <div class="calendar-event start"><strong>{{ data.project.start_date|date:"M d" }}</strong>: {{ data.project.name }} started</div>
          <div class="calendar-event end"><strong>{{ data.project.end_date|date:"M d" }}</strong>: {{ data.project.name }} deadline</div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- Modal Create Project -->
<div class="modal" id="project-modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Create New Project</h3>
      <button class="close-btn" id="close-modal">&times;</button>
    </div>
    <form id="project-form" method="POST" action="{% url 'create_project_view' %}">
      {% csrf_token %}
      <div class="form-group"><label class="form-label" for="project-name">Project Name</label><input class="form-input" id="project-name" name="project_name" required></div>
      <div class="form-group"><label class="form-label" for="project-description">Description</label><textarea class="form-input" id="project-description" name="project_description" rows="3"></textarea></div>
      <div class="form-group"><label class="form-label" for="start-date">Start Date</label><input type="date" class="form-input" id="start-date" name="start_date" required></div>
      <div class="form-group"><label class="form-label" for="end-date">End Date</label><input type="date" class="form-input" id="end-date" name="end_date" required></div>
      <div class="modal-actions"><button type="button" class="btn" id="cancel-btn">Cancel</button><button class="btn btn-primary" type="submit">Create Project</button></div>
    </form>
  </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script>
  // CSRF
  function getCookie(n){const v=`; ${document.cookie}`.split(`; ${n}=`);return v.length===2?v.pop().split(';').shift():null;}

  // Calendar data from server
  const projectDates = [
    {% for d in projects_data %}
    {name:"{{ d.project.name|escapejs }}",start:"{{ d.project.start_date|date:'Y-m-d' }}",end:"{{ d.project.end_date|date:'Y-m-d' }}",profit:{{ d.profit|default:0 }} },
    {% endfor %}
  ];

  let currentDate=new Date(), currentMonth=currentDate.getMonth(), currentYear=currentDate.getFullYear();
  const months=["January","February","March","April","May","June","July","August","September","October","November","December"];

  function generateCalendar(m,y){
    const grid=document.getElementById('calendar-days'); if(!grid) return; grid.innerHTML='';
    const f=new Date(y,m,1), l=new Date(y,m+1,0), firstIdx=f.getDay(), prevLast=new Date(y,m,0).getDate(), today=new Date();
    for(let i=firstIdx;i>0;i--){const c=document.createElement('div');c.className='day-cell other-month';c.textContent=prevLast-i+1;grid.appendChild(c);}
    for(let i=1;i<=l.getDate();i++){const c=document.createElement('div');c.className='day-cell'; if(i===today.getDate()&&m===today.getMonth()&&y===today.getFullYear()) c.classList.add('today');
      const ds=`${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
      const starts=projectDates.filter(p=>p.start===ds), ends=projectDates.filter(p=>p.end===ds);
      if(starts.length||ends.length){c.style.outline='2px solid #ddd';}
      c.textContent=i; grid.appendChild(c);
    }
    const total=42, used=firstIdx+l.getDate(); for(let i=1;i<=total-used;i++){const c=document.createElement('div');c.className='day-cell other-month';c.textContent=i;grid.appendChild(c);}
  }
  function updateMonthYear(){const el=document.getElementById('current-month'); if(el) el.textContent=`${months[currentMonth]} ${currentYear}`;}

  function openModal(){const m=document.getElementById('project-modal'); if(!m) return; m.style.display='flex';
    const s=document.getElementById('start-date'), e=document.getElementById('end-date'); if(s) s.valueAsDate=new Date(); if(e){const d=new Date(); d.setDate(d.getDate()+30); e.valueAsDate=d;}
  }
  function closeModal(){const m=document.getElementById('project-modal'); const f=document.getElementById('project-form'); if(m) m.style.display='none'; if(f) f.reset();}

  function archiveProject(id){
    if(!confirm('Are you sure you want to change the project status?')) return;
    fetch(`/projects/${id}/toggle-status/`,{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')||''},credentials:'same-origin'})
      .then(r=>r.ok?location.reload():alert('Could not change project status'))
      .catch(()=>alert('Network error'));
  }

  document.addEventListener('DOMContentLoaded',()=>{
    // Calendar
    document.getElementById('prev-month')?.addEventListener('click',()=>{currentMonth--; if(currentMonth<0){currentMonth=11;currentYear--;} generateCalendar(currentMonth,currentYear); updateMonthYear();});
    document.getElementById('next-month')?.addEventListener('click',()=>{currentMonth++; if(currentMonth>11){currentMonth=0;currentYear++;} generateCalendar(currentMonth,currentYear); updateMonthYear();});
    generateCalendar(currentMonth,currentYear); updateMonthYear();

    // Modal
    document.getElementById('new-project-btn')?.addEventListener('click',openModal);
    document.getElementById('close-modal')?.addEventListener('click',closeModal);
    document.getElementById('cancel-btn')?.addEventListener('click',closeModal);
  });
</script>
{% endblock %}