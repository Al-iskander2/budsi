{% extends 'budgidesk_app/base.html' %}
{% load static %}
{% block content %}

<div style="max-width: 1100px; margin: 32px auto; padding: 0 20px;">
  <h1 style="text-align: center;">Invoice Created!</h1>
  <p style="text-align: center;">You have now created {{ profile.invoice_count }} invoices.</p>

  <div style="display: grid; grid-template-columns: 1fr; gap: 24px;">
    <!-- LEFT: Preview -->
    <div style="background: #fff; border: 1px solid rgba(75, 73, 172, 0.18); border-radius: 16px; box-shadow: 0 10px 24px rgba(75, 73, 172, 0.10);">
      <h2 style="margin: 0; padding: 16px 18px; border-bottom: 1px solid rgba(75, 73, 172, 0.18); color: #4B49AC; font-size: 18px;">Invoice Preview</h2>
      <div style="padding: 18px;">
        {% if original_url %}
          <div style="display: flex; align-items: center; justify-content: center; background: #f6f8ff; border: 1px dashed rgba(75, 73, 172, 0.35); border-radius: 12px; min-height: 560px; overflow: hidden;">
            {% if is_pdf %}
              <embed src="{{ original_url }}" type="application/pdf" style="max-width: 100%; max-height: 100%; object-fit: contain;"/>
            {% else %}
              <img src="{{ original_url }}" alt="original invoice" style="max-width: 100%; max-height: 100%; object-fit: contain;"/>
            {% endif %}
          </div>
          <p style="margin-top: 8px; font-size: 12px; color: #6b7a90;">File: {{ invoice.original_file.name }}</p>
        {% else %}
          <div style="display: flex; align-items: center; justify-content: center; background: #f6f8ff; border: 1px dashed rgba(75, 73, 172, 0.35); border-radius: 12px; min-height: 560px; overflow: hidden;"><em>Invoice Preview.</em></div>
        {% endif %}
      </div>
    </div>

    <!-- RIGHT: Form -->
    <div style="background: #fff; border: 1px solid rgba(75, 73, 172, 0.18); border-radius: 16px; box-shadow: 0 10px 24px rgba(75, 73, 172, 0.10);">
      <h2 style="margin: 0; padding: 16px 18px; border-bottom: 1px solid rgba(75, 73, 172, 0.18); color: #4B49AC; font-size: 18px;">Client Information</h2>
      <div style="padding: 18px;">
        {% if errors %}
        <div style="margin-bottom: 1rem; background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; padding: 1rem; border-radius: 10px;">
          <ul style="margin: 0; padding-left: 1rem;">
            {% for e in errors %}<li>{{ e }}</li>{% endfor %}
          </ul>
        </div>
        {% endif %}

        <form method="post" action="{% url 'invoice_create' %}">
          {% csrf_token %}
          <div style="display: grid; grid-template-columns: 1fr; gap: 14px;">
            <div>
              <label for="contact" style="font-weight: 600; color: #2a3550; font-size: 14px;">Client / Supplier</label>
              <input type="text" name="contact" id="contact" required value="{{ form_data.contact|default_if_none:'' }}" style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px;">
            </div>
            <div>
              <label for="date" style="font-weight: 600; color: #2a3550; font-size: 14px;">Date</label>
              <input type="date" name="date" id="date" required value="{{ form_data.date|default_if_none:'' }}" style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px;">
            </div>
            <div>
              <label for="subtotal" style="font-weight: 600; color: #2a3550; font-size: 14px;">Subtotal</label>
              <input type="number" step="0.01" name="subtotal" id="subtotal" required value="{{ form_data.subtotal|default_if_none:'' }}" style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px;">
            </div>
            <div>
              <label for="vat_amount" style="font-weight: 600; color: #2a3550; font-size: 14px;">VAT</label>
              <input type="number" step="0.01" name="vat_amount" id="vat_amount" value="{{ form_data.vat_amount|default:'0' }}" style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px;">
            </div>
            <div style="grid-column: 1 / -1">
              <label for="description" style="font-weight: 600; color: #2a3550; font-size: 14px;">Description</label>
              <textarea name="description" id="description" rows="3" style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px;">{{ form_data.description }}</textarea>
            </div>
          </div>

          <div id="vat-warning" style="display: none; margin-top: 8px; background: #fff0d6; border: 1px solid #f0c36d; color: #6b4a00; padding: 10px; border-radius: 10px;">VAT amount seems inconsistent with subtotal.</div>

          <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 14px;">
            <button type="submit" style="border: 0; border-radius: 12px; padding: 12px 14px; font-weight: 700; cursor: pointer; background: linear-gradient(135deg, #7DA0FA, #4B49AC); color: #fff;">Save Invoice</button>
          </div>

          {% if messages %}
          <div style="margin-top: 1rem;">
            {% for message in messages %}
            <div style="margin-bottom: 1rem; background: #e2e3e5; padding: 1rem; border-left: 4px solid #4B49AC; border-radius: 10px;">
              {{ message }}
            </div>
            {% endfor %}
          </div>
          {% endif %}

          <div style="margin-top: 2rem; display: flex; flex-wrap: wrap; gap: 10px;">
            <button id="downloadBtn" type="button" style="background: #fff; border: 2px solid #4B49AC; color: #4B49AC; border-radius: 12px; padding: 12px 14px; font-weight: 700; cursor: pointer;">Download Invoice</button>
            <button id="showEmailBtn" type="button" style="background: #fff; border: 2px solid #4B49AC; color: #4B49AC; border-radius: 12px; padding: 12px 14px; font-weight: 700; cursor: pointer;">Send via Email</button>
            <a href="{% url 'invoice_create' %}" style="display: inline-block; background: #fff; border: 2px solid #4B49AC; color: #4B49AC; border-radius: 12px; padding: 12px 14px; font-weight: 700; text-decoration: none;">Create Another Invoice</a>
          </div>

          <div id="sendSection" style="display: none; margin-top: 20px;">
            <h4>Which email do you want to send it to?</h4>
            <input type="email" id="emailInput" placeholder="Enter email" style="margin-top: 0.5rem; width: 100%; padding: 10px 12px; border: 1px solid #4B49AC; border-radius: 10px;">
            <button type="button" id="sendEmailBtn" style="margin-top: 0.5rem; background: linear-gradient(135deg, #7DA0FA, #4B49AC); color: #fff; border: 0; border-radius: 12px; padding: 12px 14px; font-weight: 700; cursor: pointer;">Send Invoice</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // VAT Check
  (function(){
    const subtotal = document.getElementById('subtotal');
    const vat = document.getElementById('vat_amount');
    const warn = document.getElementById('vat-warning');

    function checkVAT(){
      const s = parseFloat(subtotal.value) || 0;
      const v = parseFloat(vat.value) || 0;
      warn.style.display = (v > 0 && s > 0 && v >= s) ? 'block' : 'none';
    }

    subtotal.addEventListener('input', checkVAT);
    vat.addEventListener('input', checkVAT);
    checkVAT();
  })();

  document.getElementById("downloadBtn").addEventListener("click", function() {
    window.open("{% url 'generate_invoice' %}", "_blank");
  });

  document.getElementById("showEmailBtn").addEventListener("click", function() {
    document.getElementById("sendSection").style.display = "block";
  });

  document.getElementById("sendEmailBtn").addEventListener("click", function() {
    const email = document.getElementById("emailInput").value.trim();
    if (!email) {
      alert("Please enter an email address.");
      return;
    }
    window.open("{% url 'generate_invoice' %}", "_blank");
    alert("Invoice sent successfully to " + email);
    setTimeout(function() {
      window.location.href = "{% url 'invoice_create' %}";
    }, 1000);
  });
</script>

{% endblock %}
