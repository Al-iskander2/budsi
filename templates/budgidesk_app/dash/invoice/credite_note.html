{% extends 'budgidesk_app/base.html' %}
{% load static %}
{% block content %}

<div style="max-width: 1100px; margin: 32px auto; padding: 0 20px;">
  <h1 style="text-align: center;">Create Credit Note</h1>
  <p style="text-align: center;">You have created {{ profile.credit_note_count|default:0 }} credit notes so far.</p>

  <div style="display: grid; grid-template-columns: 1fr; gap: 24px;">
    <!-- LEFT: Credit Note Information -->
    <div style="background: #fff; border: 1px solid rgba(75, 73, 172, 0.18); border-radius: 16px; box-shadow: 0 10px 24px rgba(75, 73, 172, 0.10);">
      <h2 style="margin: 0; padding: 16px 18px; border-bottom: 1px solid rgba(75, 73, 172, 0.18); color: #4B49AC; font-size: 18px;">Credit Note Details</h2>
      <div style="padding: 18px;">
        <div style="display: flex; align-items: center; justify-content: center; background: #f6f8ff; border: 1px dashed rgba(75, 73, 172, 0.35); border-radius: 12px; min-height: 200px; overflow: hidden;">
          <div style="text-align: center; color: #6b7a90;">
            <i class="fas fa-file-invoice-dollar" style="font-size: 48px; margin-bottom: 16px; color: #4B49AC;"></i>
            <p style="margin: 0; font-size: 16px;">New Credit Note Form</p>
            <p style="margin: 8px 0 0 0; font-size: 14px;">Fill out the form to create a credit note</p>
          </div>
        </div>
        <div style="margin-top: 16px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
          <h4 style="margin: 0 0 8px 0; color: #4B49AC;">Next Credit Note Number</h4>
          <p style="margin: 0; font-weight: 600; font-size: 18px;">CN-{{ profile.credit_note_count|add:1|stringformat:"06d" }}</p>
          <p style="margin: 8px 0 0 0; font-size: 12px; color: #6b7a90;">This number will be assigned automatically</p>
        </div>
      </div>
    </div>

    <!-- RIGHT: Form -->
    <div style="background: #fff; border: 1px solid rgba(75, 73, 172, 0.18); border-radius: 16px; box-shadow: 0 10px 24px rgba(75, 73, 172, 0.10);">
      <h2 style="margin: 0; padding: 16px 18px; border-bottom: 1px solid rgba(75, 73, 172, 0.18); color: #4B49AC; font-size: 18px;">Credit Note Information</h2>
      <div style="padding: 18px;">
        {% if errors %}
        <div style="margin-bottom: 1rem; background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; padding: 1rem; border-radius: 10px;">
          <ul style="margin: 0; padding-left: 1rem;">
            {% for e in errors %}<li>{{ e }}</li>{% endfor %}
          </ul>
        </div>
        {% endif %}

        {% if messages %}
        <div style="margin-bottom: 1rem;">
          {% for message in messages %}
          <div style="margin-bottom: 0.5rem; background: {% if message.tags == 'success' %}#d1edff{% else %}#f8d7da{% endif %}; color: {% if message.tags == 'success' %}#0c5460{% else %}#721c24{% endif %}; border: 1px solid {% if message.tags == 'success' %}#bee5eb{% else %}#f5c6cb{% endif %}; padding: 1rem; border-radius: 10px;">
            {{ message }}
          </div>
          {% endfor %}
        </div>
        {% endif %}

        <form method="post" action="{% url 'credit_note_save' %}">
          {% csrf_token %}
          <div style="display: grid; grid-template-columns: 1fr; gap: 14px;">
            <div>
              <label for="contact" style="font-weight: 600; color: #2a3550; font-size: 14px;">Client Name *</label>
              <input type="text" name="contact" id="contact" required 
                     value="{% if initial_data.contact %}{{ initial_data.contact }}{% else %}{{ form_data.contact|default_if_none:'' }}{% endif %}" 
                     placeholder="Enter client or company name"
                     style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px;">
              <small style="color: #6b7a90; font-size: 12px;">This client will be added to your contacts</small>
            </div>
            
            <div>
              <label for="date" style="font-weight: 600; color: #2a3550; font-size: 14px;">Credit Note Date *</label>
              <input type="date" name="date" id="date" required value="{{ form_data.date|default_if_none:'' }}" 
                     style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px;">
            </div>

            <div>
              <label for="reason" style="font-weight: 600; color: #2a3550; font-size: 14px;">Reason for Credit Note *</label>
              <select name="reason" id="reason" required style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px;">
                <option value="">Select a reason</option>
                <option value="return">Product Return</option>
                <option value="damaged">Damaged Goods</option>
                <option value="incorrect_billing">Incorrect Billing</option>
                <option value="price_adjustment">Price Adjustment</option>
                <option value="cancellation">Order Cancellation</option>
                <option value="other">Other</option>
              </select>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px;">
              <div>
                <label for="subtotal" style="font-weight: 600; color: #2a3550; font-size: 14px;">Subtotal (€) *</label>
                <input type="number" step="0.01" name="subtotal" id="subtotal" required 
                       value="{% if initial_data.subtotal %}{{ initial_data.subtotal }}{% else %}{{ form_data.subtotal|default_if_none:'' }}{% endif %}" 
                       placeholder="0.00"
                       style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px;">
              </div>
              <div>
                <label for="vat_amount" style="font-weight: 600; color: #2a3550; font-size: 14px;">VAT (€)</label>
                <input type="number" step="0.01" name="vat_amount" id="vat_amount" 
                       value="{% if initial_data.vat_amount %}{{ initial_data.vat_amount }}{% else %}{{ form_data.vat_amount|default:'0' }}{% endif %}" 
                       placeholder="0.00"
                       style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px;">
              </div>
            </div>
            
            <div>
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <label for="total" style="font-weight: 600; color: #2a3550; font-size: 14px;">Total Credit Amount</label>
                <span id="totalDisplay" style="font-weight: 700; color: #e74c3c; font-size: 16px;">-€0.00</span>
              </div>
              <input type="hidden" id="total" name="total">
              <small style="color: #6b7a90; font-size: 12px;">Calculated automatically: Subtotal + VAT (negative amounts)</small>
            </div>
            
            <div style="grid-column: 1 / -1">
              <label for="description" style="font-weight: 600; color: #2a3550; font-size: 14px;">Description</label>
              <textarea name="description" id="description" rows="3" 
                        placeholder="Describe the reason for this credit note..."
                        style="width: 100%; padding: 10px 12px; border: 1px solid rgba(75, 73, 172, 0.35); border-radius: 10px;">{% if initial_data.description %}{{ initial_data.description }}{% else %}{{ form_data.description }}{% endif %}</textarea>
            </div>
          </div>

          <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 24px;">
            <button type="submit" style="border: 0; border-radius: 12px; padding: 12px 24px; font-weight: 700; cursor: pointer; background: linear-gradient(135deg, #e74c3c, #c0392b); color: #fff; flex: 1;">
              <i class="fas fa-file-invoice-dollar"></i> Create Credit Note
            </button>
            <a href="{% url 'invoice_list' %}" style="display: inline-block; background: #fff; border: 2px solid #4B49AC; color: #4B49AC; border-radius: 12px; padding: 12px 14px; font-weight: 700; text-decoration: none;">
              <i class="fas fa-arrow-left"></i> Back to Invoices
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script>
  // Total Calculation for Credit Note (negative amounts)
  (function(){
    const subtotal = document.getElementById('subtotal');
    const vat = document.getElementById('vat_amount');
    const totalDisplay = document.getElementById('totalDisplay');

    function calculateTotal(){
      const s = parseFloat(subtotal.value) || 0;
      const v = parseFloat(vat.value) || 0;
      const total = s + v;
      
      // Update total display (negative for credit notes)
      totalDisplay.textContent = '-€' + Math.abs(total).toFixed(2);
      totalDisplay.style.color = '#e74c3c'; // Red color for negative amounts
    }

    subtotal.addEventListener('input', calculateTotal);
    vat.addEventListener('input', calculateTotal);
    
    // Initialize calculation
    calculateTotal();

    // Set default date to today
    document.addEventListener('DOMContentLoaded', function() {
      const today = new Date().toISOString().split('T')[0];
      const dateField = document.getElementById('date');
      if (!dateField.value) {
        dateField.value = today;
      }
    });
  })();
</script>

{% endblock %}