{% extends 'budgidesk_app/base.html' %}
{% load static %}
{% block content %}

<style>
  :root {
    --green-500: #01BF1F;
    --blue-900: #324EA2;
    --blue-700: #4064D2;
    --blue-500: #7498D4;
    --white: #FFFFFF;
    --gold: #D3AF3F;
  }
  .preview-wrap {
    max-width: 1100px;
    margin: 32px auto;
    padding: 0 20px;
  }
  .grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 24px;
  }
  @media(min-width: 960px) {
    .grid { grid-template-columns: 1fr 1fr; }
  }
  .panel {
    background: #fff;
    border: 1px solid rgba(116,152,212,.18);
    border-radius: 16px;
    box-shadow: 0 10px 24px rgba(50,78,162,.10);
  }
  .panel h2 {
    margin: 0;
    padding: 16px 18px;
    border-bottom: 1px solid rgba(116,152,212,.18);
    color: var(--blue-900);
    font-size: 18px;
  }
  .panel-body {
    padding: 18px;
  }
  .docbox {
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f6f8ff;
    border: 1px dashed rgba(50,78,162,.35);
    border-radius: 12px;
    min-height: 560px;
    overflow: hidden;
  }
  .docbox img,
  .docbox embed {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }
  form .row {
    display: grid;
    grid-template-columns: 1fr;
    gap: 14px;
  }
  @media(min-width: 680px) {
    form .row { grid-template-columns: 1fr 1fr; }
  }
  label {
    font-weight: 600;
    color: #2a3550;
    font-size: 14px;
  }
  input, select, textarea {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid rgba(50,78,162,.35);
    border-radius: 10px;
  }
  .actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 14px;
  }
  .btn {
    border: 0;
    border-radius: 12px;
    padding: 12px 14px;
    font-weight: 700;
    cursor: pointer;
  }
  .btn-primary {
    background: linear-gradient(135deg, var(--green-500), var(--blue-700));
    color: #fff;
  }
  .btn-outline {
    background: #fff;
    border: 2px solid var(--blue-700);
    color: var(--blue-900);
  }
  .note {
    margin-top: 8px;
    font-size: 12px;
    color: #6b7a90;
  }
  .warn {
    display: none;
    margin-top: 8px;
    background: #fff0d6;
    border: 1px solid #f0c36d;
    color: #6b4a00;
    padding: 10px;
    border-radius: 10px;
  }
</style>

<div class="container text-center mt-4">
  <h1>Invoice Created!</h1>
  <p>You have now created {{ profile.invoice_count }} invoices.</p>

  <div class="preview-wrap">
    <div class="grid">

      <!-- LEFT: Preview -->
      <div class="panel">
        <h2>Invoice Preview</h2>
        <div class="panel-body">
          {% if original_url %}
            <div class="docbox">
              {% if is_pdf %}
                <embed src="{{ original_url }}" type="application/pdf" />
              {% else %}
                <img src="{{ original_url }}" alt="original invoice"/>
              {% endif %}
            </div>
            <p class="note">File: {{ invoice.original_file.name }}</p>
          {% else %}
            <div class="docbox"><em>Invoice Preview.</em></div>
          {% endif %}
        </div>
      </div>

      <!-- RIGHT: Form -->
      <div class="panel">
        <h2>Client Information</h2>
        <div class="panel-body">

          {% if errors %}
            <div class="alert alert-danger">
              <ul class="mb-0">{% for e in errors %}<li>{{ e }}</li>{% endfor %}</ul>
            </div>
          {% endif %}

          <form method="post" action="{% url 'invoice_create' %}">
            {% csrf_token %}
            <div class="row">
              <div>
                <label for="client">Client / Supplier</label>
                <input type="text" name="client" id="client" required
                      value="{{ form_data.client|default_if_none:'' }}">
              </div>
              <div>
                <label for="date">Date</label>
                <input type="date" name="date" id="date" required
                      value="{{ form_data.date|default_if_none:'' }}">
              </div>
              <div>
                <label for="amount">Total (Gross)</label>
                <input type="number" step="0.01" name="amount" id="amount" required
                      value="{{ form_data.amount|default_if_none:'' }}">
              </div>
              <div>
                <label for="vat">VAT</label>
                <input type="number" step="0.01" name="vat" id="vat"
                      value="{{ form_data.vat|default:'0' }}">
              </div>
              <div style="grid-column: 1 / -1">
                <label for="description">Description</label>
                <textarea name="description" id="description" rows="3">{{ form_data.description }}</textarea>
              </div>
            </div>

            <div id="vat-warning" class="warn">VAT amount seems inconsistent with total.</div>

            <div class="actions">
              <button type="submit" class="btn btn-primary">Save Invoice</button>
            </div>

            {% if messages %}
              <div class="container mt-3">
                {% for message in messages %}
                  <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  </div>
                {% endfor %}
              </div>
            {% endif %}

            <!-- AFTER SAVE ACTIONS -->
            <div class="mt-4">
              <button id="downloadBtn" class="btn btn-outline" type="button">Download Invoice</button>
              <button id="showEmailBtn" class="btn btn-outline" type="button">Send via Email</button>
              <a href="{% url 'invoice_create' %}" class="btn btn-outline">Create Another Invoice</a>
            </div>

            <!-- EMAIL SECTION -->
            <div id="sendSection" style="display: none; margin-top: 20px;">
              <h4>Which email do you want to send it to?</h4>
              <input type="email" id="emailInput" class="form-control mt-2" placeholder="Enter email">
              <button type="button" class="btn btn-primary mt-2" id="sendEmailBtn">Send Invoice</button>
            </div>

          </form>

        </div>
      </div>

    </div>
  </div>

<script>
  // VAT Check
  (function(){
    const amount = document.getElementById('amount');
    const vat = document.getElementById('vat');
    const warn = document.getElementById('vat-warning');

    function checkVAT(){
      const a = parseFloat(amount.value) || 0;
      const v = parseFloat(vat.value) || 0;
      warn.style.display = (v > 0 && a > 0 && v >= a) ? 'block' : 'none';
    }

    amount.addEventListener('input', checkVAT);
    vat.addEventListener('input', checkVAT);
    checkVAT();
  })();

  // DOWNLOAD
  document.getElementById("downloadBtn").addEventListener("click", function() {
    window.open("{% url 'generate_invoice' %}", "_blank");
  });

  // SHOW EMAIL INPUT
  document.getElementById("showEmailBtn").addEventListener("click", function() {
    document.getElementById("sendSection").style.display = "block";
  });

  // SEND EMAIL (Simulation)
  document.getElementById("sendEmailBtn").addEventListener("click", function() {
    const email = document.getElementById("emailInput").value.trim();
    if (!email) {
      alert("Please enter an email address.");
      return;
    }

    // Simulate sending email
    window.open("{% url 'generate_invoice' %}", "_blank");
    alert("Invoice sent successfully to " + email);

    setTimeout(function() {
      window.location.href = "{% url 'invoice_create' %}";
    }, 1000);
  });
</script>

{% endblock %}
