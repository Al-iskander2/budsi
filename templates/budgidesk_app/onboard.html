{% extends 'budgidesk_app/base.html' %}

{% block content %}
  <style>
    body {
      padding: 0 !important;
      margin: 0 !important;
    }


    :root {
      --primary-1: #4B49AC;
      --primary-2: #98BDFF;
      --supporting-1: #7DA0FA;
      --supporting-2: #7978E9;
      --supporting-3: #F3797E;
      --white: #ffffff;
      --gray-light: #f5f5f5;
      --gray-border: #e0e0e0;
      --amber: #f39c12;
    }
    
    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--gray-light);
      margin: 0;
      padding: 2rem;
      text-align: center;
      color: #333;
    }
    .container {
      width: 90%;
      max-width: 600px;
      margin: auto;
      background: var(--white);
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    header h2 {
      color: var(--primary-1);
      font-size: 1.8rem;
      margin-bottom: .3rem;
    }
    header p, #progress {
      color: #555;
      margin: 0.3rem 0 1.5rem;
    }
    .progress-bar {
      display: flex;
      justify-content: center;
      margin-bottom: 1.5rem;
    }
    .circle {
      width: 12px; height: 12px;
      border-radius: 50%;
      background: #ccc;
      margin: 0 .3rem;
      transition: background .3s;
    }
    .circle.active {
      background: var(--primary-1);
    }
    .step {
      display: none;
    }
    .step.active {
      display: block;
    }
    .step-content {
      opacity: 0;
      transform: translateY(40px);
      transition: opacity .5s ease, transform .5s ease;
    }
    label {
      display: block;
      text-align: left;
      margin: 1rem 0 .3rem;
      font-weight: 500;
    }
    input, select, button {
      width: 100%;
      margin-bottom: 1rem;
    }
    input, select {
      padding: .8rem;
      font-size: 1rem;
      border: 1px solid var(--gray-border);
      border-radius: 6px;
      transition: border-color .3s, box-shadow .3s;
    }
    input:focus, select:focus {
      border-color: var(--primary-1);
      box-shadow: 0 0 6px rgba(75, 73, 172, 0.3);
      outline: none;
    }
    button {
      padding: 1rem;
      background: var(--primary-1);
      color: var(--white);
      font-size: 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background .3s;
    }
    button:hover {
      background: var(--supporting-2);
    }
    .error {
      color: var(--supporting-3);
      font-size: 0.9rem;
      margin-top: -0.8rem;
      margin-bottom: 0.8rem;
      text-align: left;
    }
    .optional {
      color: #666;
      font-style: italic;
    }
  </style>

  <div class="container">
    <header>
      <h2 id="mainHeader">Hey there!</h2>
      <p id="subHeader">
        We'll ask you a few simple things to build your smart dashboardâ€”skip anything you're not ready for!
      </p>
      <p id="progress">Step 1 of 7</p>
      <div class="progress-bar">
        <span class="circle active"></span>
        <span class="circle"></span>
        <span class="circle"></span>
        <span class="circle"></span>
        <span class="circle"></span>
        <span class="circle"></span>
        <span class="circle"></span>
      </div>
    </header>

    <form id="onboardForm" method="post" enctype="multipart/form-data">
      {% csrf_token %}

      <!-- Paso 1 -->
      <div class="step active" id="step1">
        <div class="step-content">
          <p>Let's get you set up with BudsiDesk in just a few steps.</p>
          <button type="button" onclick="nextStep(1)">Let's Begin</button>
        </div>
      </div>

      <!-- Paso 2 -->
      <div class="step" id="step2">
        <div class="step-content">
          <label for="contact_full_name">What's your name? *</label>
          <input type="text" id="contact_full_name" name="contact_full_name" required>

          <label for="phone">Got a phone number? <span class="optional">(optional)</span></label>
          <input type="tel" id="phone" name="phone">

          <label for="logo">Add your logo <span class="optional">(optional)</span></label>
          <input type="file" id="logo" name="logo" accept="image/png, image/jpeg">

          <button type="button" onclick="validateStep2()">Next</button>
        </div>
      </div>

      <!-- Paso 3 -->
      <div class="step" id="step3">
        <div class="step-content">
          <label for="business_name">Business name (or just your name!) *</label>
          <input type="text" id="business_name" name="business_name" required>

          <label for="profession">What do you do best? *</label>
          <select id="profession" name="profession" required>
            <option value="">Select your profession...</option>
            <option value="Creative & Digital">Creative & Digital</option>
            <option value="Business & Finance">Business & Finance</option>
            <option value="Tech & Development">Tech & Development</option>
            <option value="Language & Communication">Language & Communication</option>
            <option value="Education & Coaching">Education & Coaching</option>
            <option value="Trades & Skilled Work">Trades & Skilled Work</option>
            <option value="Health & Wellness">Health & Wellness</option>
            <option value="Lifestyle & Events">Lifestyle & Events</option>
            <option value="Retail & Craft">Retail & Craft</option>
            <option value="Other">Other</option>
          </select>

          <label for="sector">What sector do you mostly work in? *</label>
          <select id="sector" name="sector" required>
            <option value="">Select your sector...</option>
            <option value="Graphic Design">Graphic Design</option>
            <option value="Web Design">Web Design</option>
            <option value="Content Writing">Content Writing</option>
            <option value="Copywriting">Copywriting</option>
            <option value="Video Editing">Video Editing</option>
            <option value="Photography">Photography</option>
            <option value="Social Media Management">Social Media Management</option>
            <option value="Digital Marketing">Digital Marketing</option>
            <option value="Branding Consultant">Branding Consultant</option>
            <option value="Virtual Assistant">Virtual Assistant</option>
            <option value="Project Management">Project Management</option>
            <option value="Data Entry">Data Entry</option>
            <option value="Web Development">Web Development</option>
            <option value="Software Development">Software Development</option>
            <option value="App Development">App Development</option>
            <option value="Cybersecurity">Cybersecurity</option>
            <option value="Translator">Translator</option>
            <option value="Editor">Editor</option>
            <option value="Voiceover Artist">Voiceover Artist</option>
            <option value="Language Tutor">Language Tutor</option>
            <option value="Online Tutor">Online Tutor</option>
            <option value="Career Coach">Career Coach</option>
            <option value="Life Coach">Life Coach</option>
            <option value="Workshop Facilitator">Workshop Facilitator</option>
            <option value="E-learning Creator">E-learning Creator</option>
            <option value="Electrician">Electrician</option>
            <option value="Plumber">Plumber</option>
            <option value="Carpenter">Carpenter</option>
            <option value="Handyman">Handyman</option>
            <option value="Mechanic">Mechanic</option>
            <option value="Cleaner">Cleaner</option>
            <option value="Personal Trainer">Personal Trainer</option>
            <option value="Yoga Instructor">Yoga Instructor</option>
            <option value="Massage Therapist">Massage Therapist</option>
            <option value="Nutritionist">Nutritionist</option>
            <option value="Wellness Coach">Wellness Coach</option>
            <option value="Chef / Caterer">Chef / Caterer</option>
            <option value="Event Planner">Event Planner</option>
            <option value="Wedding Photographer">Wedding Photographer</option>
            <option value="DJ / Entertainer">DJ / Entertainer</option>
            <option value="Florist">Florist</option>
            <option value="E-commerce Seller">E-commerce Seller</option>
            <option value="Etsy Shop Owner">Etsy Shop Owner</option>
            <option value="Craftsperson / Maker">Craftsperson / Maker</option>
            <option value="Jewellery Designer">Jewellery Designer</option>
            <option value="Fashion Designer">Fashion Designer</option>
            <option value="Other">Other</option>
          </select>

          <button type="button" onclick="validateStep3()">Next</button>
        </div>
      </div>

      <!-- Paso 4 -->
      <div class="step" id="step4">
        <div class="step-content">
          <label for="currency">Preferred currency *</label>
          <select id="currency" name="currency" required>
            <option value="">Select currency...</option>
            <option value="EUR">EUR (Euro)</option>
            <option value="GBP">GBP (British Pound)</option>
            <option value="USD">USD (US Dollar)</option>
          </select>

          <label>Want us to set up invoice defaults for you? *</label>
          <select id="invoice_defaults" name="invoice_defaults" required>
            <option value="">Select an option...</option>
            <option value="1">Yes, please!</option>
            <option value="0">No, I'll set them up later</option>
          </select>

          <label for="payment_terms">Payment terms <span class="optional">(e.g., 7 days, Net 30)</span></label>
          <input type="text" id="payment_terms" name="payment_terms" placeholder="e.g., 7 days">

          <label for="late_notice">Late payment notice <span class="optional">(optional)</span></label>
          <input type="text" id="late_notice" name="late_notice" placeholder="e.g., Reminder after 30 days">

          <label for="payment_methods">Preferred payment methods <span class="optional">(optional)</span></label>
          <input type="text" id="payment_methods" name="payment_methods" placeholder="e.g., Bank transfer, Stripe">

          <button type="button" onclick="validateStep4()">Next</button>
        </div>
      </div>

      <!-- Paso 5 -->
      <div class="step" id="step5">
        <div class="step-content">
          <label for="vat_registered">Are you VAT registered? *</label>
          <select id="vat_registered" name="vat_registered" required>
            <option value="">Select an option...</option>
            <option value="0">No</option>
            <option value="1">Yes</option>
          </select>

          <div id="vat_section" style="display:none">
            <label for="vat_number">VAT number *</label>
            <input type="text" id="vat_number" name="vat_number" placeholder="e.g., 1234567X">
            <div id="vat_error" class="error"></div>
          </div>

          <label for="pps_number">PPS number <span class="optional">(optional)</span></label>
          <input type="text" id="pps_number" name="pps_number" placeholder="e.g., 1234567X">
          <div id="pps_error" class="error"></div>

          <button type="button" onclick="validateStep5()">Next</button>
        </div>
      </div>

      <!-- Paso 6 -->
      <div class="step" id="step6">
        <div class="step-content">
          <label for="iban">Bank account (IBAN) *</label>
          <input type="text" id="iban" name="iban" required placeholder="IE29AIBK93115212345678">
          <div id="iban_error" class="error"></div>
          <p style="font-size: 0.9rem; color: #666; text-align: left; margin-top: -0.5rem;">
            Format: IE followed by 22 characters (e.g., IE29AIBK93115212345678)
          </p>

          <button type="button" onclick="validateStep6()">Next</button>
        </div>
      </div>

      <!-- Paso 7: submit -->
      <div class="step" id="step7">
        <div class="step-content">
          <h2>You're ready to rock your Solo Finances!</h2>
          <p>We'll take it from here and set up your smart dashboard.</p>
          <button type="submit">View Your Dashboard</button>
        </div>
      </div>
    </form>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script>
    const totalSteps = 7;
    const circles = document.querySelectorAll('.circle');
    const headers = [
      { title: 'Hey there!', sub: 'Welcome to BudsiDesk' },
      { title: 'Who\'s behind the biz?', sub: 'Tell us about yourself' },
      { title: 'Your Solo Venture', sub: 'Business details' },
      { title: 'Let\'s talk money', sub: 'Payment preferences' },
      { title: 'Tax stuff (we keep it safe)', sub: 'Fiscal information' },
      { title: 'Getting Paid', sub: 'Bank account details' },
      { title: 'That\'s it!', sub: 'We\'ll take it from here.' }
    ];

    // Inicializar eventos
    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById('vat_registered').addEventListener('change', function(e) {
        document.getElementById('vat_section').style.display = e.target.value === '1' ? 'block' : 'none';
        if (e.target.value === '1') {
          document.getElementById('vat_number').required = true;
        } else {
          document.getElementById('vat_number').required = false;
        }
      });
      
      showStep(1);
    });

    function showStep(i) {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      circles.forEach((c, idx) => c.classList.toggle('active', idx < i));
      const st = document.getElementById(`step${i}`);
      st.classList.add('active');
      gsap.fromTo(st.querySelector('.step-content'),
                  { y: 40, opacity: 0 },
                  { y: 0, opacity: 1, duration: .6 });
      document.getElementById('progress').textContent = `Step ${i} of ${totalSteps}`;
      document.getElementById('mainHeader').textContent = headers[i-1].title;
      document.getElementById('subHeader').textContent = headers[i-1].sub;
    }

    function nextStep(c) {
      gsap.to(`#step${c} .step-content`, {
        y: -40, opacity: 0, duration: .4,
        onComplete: () => showStep(c+1)
      });
    }

    function validateStep2() {
      const name = document.getElementById('contact_full_name').value.trim();
      if (!name) {
        alert('Please fill in your name.');
        return;
      }
      nextStep(2);
    }

    function validateStep3() {
      const businessName = document.getElementById('business_name').value.trim();
      const profession = document.getElementById('profession').value;
      const sector = document.getElementById('sector').value;
      
      if (!businessName || !profession || !sector) {
        alert('Please fill in all required fields.');
        return;
      }
      nextStep(3);
    }

    function validateStep4() {
      const currency = document.getElementById('currency').value;
      const invoiceDefaults = document.getElementById('invoice_defaults').value;
      
      if (!currency || invoiceDefaults === '') {
        alert('Please fill in all required fields.');
        return;
      }
      nextStep(4);
    }

    function validateStep5() {
      let valid = true;
      const vatRegistered = document.getElementById('vat_registered').value;
      const vatNumber = document.getElementById('vat_number').value.trim();
      const ppsNumber = document.getElementById('pps_number').value.trim();

      // Validar VAT si estÃ¡ registrado
      if (vatRegistered === '1') {
        if (!vatNumber) {
          document.getElementById('vat_error').textContent = 'VAT number is required.';
          valid = false;
        } else if (!/^\d{7}[A-Za-z]{1,2}$/.test(vatNumber)) {
          document.getElementById('vat_error').textContent = 'Invalid VAT number format (e.g., 1234567X).';
          valid = false;
        } else {
          document.getElementById('vat_error').textContent = '';
        }
      } else {
        document.getElementById('vat_error').textContent = '';
      }

      // Validar PPS si se proporciona
      if (ppsNumber && !/^\d{7}[A-Za-z]{1,2}$/.test(ppsNumber)) {
        document.getElementById('pps_error').textContent = 'Invalid PPS number format (e.g., 1234567X).';
        valid = false;
      } else {
        document.getElementById('pps_error').textContent = '';
      }

      if (vatRegistered === '') {
        alert('Please select if you are VAT registered or not.');
        valid = false;
      }

      if (valid) nextStep(5);
    }

    function validateStep6() {
      const iban = document.getElementById('iban').value.trim().toUpperCase();
      document.getElementById('iban').value = iban; // Mostrar en mayÃºsculas
      
      // ValidaciÃ³n bÃ¡sica de IBAN (formato IE + 22 caracteres alfanumÃ©ricos)
      if (!/^IE\d{2}[A-Z0-9]{18}$/.test(iban)) {
        document.getElementById('iban_error').textContent = 'Please enter a valid Irish IBAN (IE followed by 22 characters).';
        return;
      } else {
        document.getElementById('iban_error').textContent = '';
        nextStep(6);
      }
    }
  </script>
{% endblock %}